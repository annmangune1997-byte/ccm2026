<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Call Center & Delivery Analytics Dashboard</title>
<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #4361ee;
  --primary-dark: #3a0ca3;
  --secondary: #4cc9f0;
  --success: #2ec4b6;
  --warning: #ff9f1c;
  --danger: #e71d36;
  --dark: #2b2d42;
  --light: #f8f9fa;
  --gray: #8d99ae;
  --bg: #f0f2f5;
  --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --transition: all 0.3s ease;
}

body {
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background-color: var(--bg);
  color: var(--dark);
}

h1, h2, h3 { margin: 0; font-weight: 600; }

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  background: white;
  padding: 15px 25px;
  border-radius: 12px;
  box-shadow: var(--card-shadow);
}

header h1 { font-size: 1.5rem; color: var(--dark); }
.header-actions button { margin-left: 10px; }

/* Dashboard Cards */
.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-left: 4px solid transparent;
  transition: var(--transition);
}

.card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
.card.blue { border-left-color: var(--primary); }
.card.teal { border-left-color: var(--success); }
.card.orange { border-left-color: var(--warning); }
.card.red { border-left-color: var(--danger); }
.card.dark { border-left-color: var(--dark); }

.card-info { display: flex; flex-direction: column; }
.card-info h3 { font-size: 0.85rem; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
.card-info h2 { font-size: 1.8rem; color: var(--dark); }
.card-icon { font-size: 2rem; opacity: 0.2; color: var(--dark); }

/* Main Layout */
.main-grid {
  display: grid;
  grid-template-columns: 350px 1fr;
  gap: 25px;
  align-items: start;
}

@media (max-width: 1000px) {
  .main-grid { grid-template-columns: 1fr; }
}

/* Panel Styles (Form & Filter) */
.panel {
  background: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  margin-bottom: 25px;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 500; color: var(--dark); }
input, select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  font-size: 0.95rem;
  transition: border-color 0.2s;
  box-sizing: border-box; /* Fix padding issues */
}
input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: var(--transition);
  color: white;
  gap: 8px;
}
.btn-primary { background-color: var(--primary); }
.btn-primary:hover { background-color: var(--primary-dark); }
.btn-success { background-color: var(--success); }
.btn-success:hover { background-color: #208b81; }
.btn-danger { background-color: var(--danger); }
.btn-danger:hover { background-color: #b9152a; }
.btn-secondary { background-color: var(--gray); }
.btn-secondary:hover { background-color: #6c757d; }
.btn-sm { padding: 6px 12px; font-size: 0.8rem; }

.form-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }

/* Edit Mode Indicator */
#editMode {
  background-color: #e0fbfc;
  border: 1px solid #98c1d9;
  color: #023047;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 6px;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 10px;
}
#editMode i { color: var(--primary-dark); }

/* Branch Sections */
.branch-section {
  background: #fff;
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  margin-bottom: 30px;
  overflow: hidden;
  animation: fadeIn 0.4s ease-out;
}

.branch-header {
  background: #fff;
  padding: 20px 25px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.branch-header h2 { font-size: 1.25rem; display: flex; align-items: center; gap: 10px; }
.branch-badge {
  background: #eff2f7;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  color: var(--gray);
  font-weight: 600;
}

/* Branch Summary Cards */
.branch-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 15px;
  padding: 20px 25px;
  background: #fafbfc;
  border-bottom: 1px solid #eee;
}

.summary-item { text-align: center; }
.summary-item .label { font-size: 0.8rem; color: var(--gray); text-transform: uppercase; margin-bottom: 5px; }
.summary-item .value { font-size: 1.4rem; font-weight: 700; color: var(--dark); }
.summary-item .value.green { color: var(--success); }
.summary-item .value.red { color: var(--danger); }

/* Mini Chart (Visual Bar) */
.chart-bar-bg {
  width: 100%;
  height: 6px;
  background: #e9ecef;
  border-radius: 3px;
  margin-top: 5px;
  overflow: hidden;
}
.chart-bar-fill {
  height: 100%;
  background: var(--primary);
  border-radius: 3px;
  transition: width 0.5s ease;
}

/* Tables */
.table-wrapper { overflow-x: auto; padding: 0; }
table { width: 100%; border-collapse: collapse; min-width: 600px; }
th, td { padding: 14px 25px; text-align: left; border-bottom: 1px solid #eee; }
th {
  background-color: #f8f9fa;
  color: var(--gray);
  font-weight: 600;
  font-size: 0.85rem;
  text-transform: uppercase;
  cursor: pointer;
  user-select: none;
  position: sticky;
  top: 0;
}
th:hover { background-color: #e9ecef; color: var(--dark); }
th i { margin-left: 5px; font-size: 0.8em; opacity: 0.5; }
tbody tr { transition: background-color 0.2s; }
tbody tr:hover { background-color: #f8f9fa; }

/* Status Indicators */
.badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 600;
  display: inline-block;
}
.badge-success { background: #d1fae5; color: #065f46; }
.badge-warning { background: #fef3c7; color: #92400e; }
.badge-danger { background: #fee2e2; color: #991b1b; }
.badge-neutral { background: #f3f4f6; color: #374151; }

/* Toast Notification */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}
.toast {
  background: white;
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-left: 4px solid var(--primary);
  animation: slideIn 0.3s ease-out;
  min-width: 250px;
}
.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--danger); }

/* Animations */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* Print Specifics */
@media print {
  .no-print, .form-container, .header-actions, .dashboard, .form-actions { display: none !important; }
  body { background: white; padding: 0; margin: 0; }
  .main-grid { display: block; }
  .branch-section { box-shadow: none; border: 1px solid #ddd; margin-bottom: 30px; break-inside: avoid; }
  .card { border: 1px solid #ddd; box-shadow: none; }
  .table-wrapper { overflow: visible; }
  th { position: static; }
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div>
    <h1><i class="fas fa-headset" style="color: var(--primary);"></i> Operations Dashboard</h1>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary btn-sm" onclick="exportData()"><i class="fas fa-file-export"></i> Export CSV</button>
    <button class="btn btn-primary btn-sm" onclick="window.print()"><i class="fas fa-print"></i> Print Report</button>
  </div>
</header>

<!-- Overall Dashboard -->
<div class="dashboard">
  <div class="card blue">
    <div class="card-info">
      <h3>Total Orders (CC)</h3>
      <h2 id="totalOrdersCC">0</h2>
    </div>
    <div class="card-icon"><i class="fas fa-phone-volume"></i></div>
  </div>
  <div class="card teal">
    <div class="card-info">
      <h3>Total Picked Up</h3>
      <h2 id="totalPickedUp">0</h2>
    </div>
    <div class="card-icon"><i class="fas fa-truck-pickup"></i></div>
  </div>
  <div class="card orange">
    <div class="card-info">
      <h3>Total Delivered</h3>
      <h2 id="totalDelivered">0</h2>
    </div>
    <div class="card-icon"><i class="fas fa-truck-fast"></i></div>
  </div>
  <div class="card dark">
    <div class="card-info">
      <h3>Success Rate</h3>
      <h2 id="deliveryRate">0%</h2>
    </div>
    <div class="card-icon"><i class="fas fa-chart-line"></i></div>
  </div>
  <div class="card red">
    <div class="card-info">
      <h3>Net Variance</h3>
      <h2 id="totalDifference">0</h2>
    </div>
    <div class="card-icon"><i class="fas fa-balance-scale"></i></div>
  </div>
</div>

<div class="main-grid">
  <!-- Left Column: Controls -->
  <div class="controls-column">
    
    <!-- Data Entry Form -->
    <div class="panel form-container">
      <div class="panel-header">
        <h3><i class="fas fa-edit"></i> Data Entry</h3>
      </div>
      
      <div id="editMode" style="display:none;">
        <i class="fas fa-exclamation-circle"></i> <strong>Editing Entry:</strong> Update fields and save.
      </div>

      <form id="dataForm" onsubmit="event.preventDefault(); addRow();">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="entryDate" required>
        </div>
        
        <div class="form-group">
          <label>Branch</label>
          <select id="branchSelect">
            <option>Hamdan St</option><option>Al Khalidiyah</option><option>Shabiya 11</option><option>Muroor</option>
            <option>Al Majaz</option><option>Al Barsha</option><option>Al Satwa</option><option>Al Rigga</option>
          </select>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div class="form-group">
            <label>Orders (In)</label>
            <input type="number" id="ordersReceived" min="0" placeholder="0">
          </div>
          <div class="form-group">
            <label>Picked Up</label>
            <input type="number" id="pickedUp" min="0" placeholder="0">
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
           <div class="form-group">
            <label>Cancelled (CC)</label>
            <input type="number" id="cancelledCC" min="0" placeholder="0">
          </div>
          <div class="form-group">
            <label>Delivered (DL)</label>
            <input type="number" id="ordersDelivered" min="0" placeholder="0">
          </div>
        </div>
        
        <div class="form-actions">
          <button id="addBtn" type="submit" class="btn btn-primary" style="flex:1"><i class="fas fa-plus"></i> Add Entry</button>
          <button id="updateBtn" type="button" class="btn btn-success" onclick="updateRow()" style="display:none; flex:1"><i class="fas fa-save"></i> Update</button>
          <button id="cancelBtn" type="button" class="btn btn-secondary" onclick="cancelEdit()" style="display:none;"><i class="fas fa-times"></i></button>
        </div>
      </form>
    </div>

    <!-- Filter Panel -->
    <div class="panel">
      <div class="panel-header">
        <h3><i class="fas fa-filter"></i> Filters</h3>
        <button class="btn btn-sm btn-secondary" onclick="clearFilters()" style="padding: 2px 8px; font-size: 0.7rem;">Reset</button>
      </div>
      
      <div class="form-group">
        <label>Branch</label>
        <select id="filterBranch" onchange="applyFilter()">
          <option value="">All Branches</option>
          <option>Hamdan St</option><option>Al Khalidiyah</option><option>Shabiya 11</option><option>Muroor</option>
          <option>Al Majaz</option><option>Al Barsha</option><option>Al Satwa</option><option>Al Rigga</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Date Range</label>
        <div style="display:flex; gap:5px;">
          <input type="date" id="filterStartDate" onchange="applyFilter()" placeholder="Start">
          <input type="date" id="filterEndDate" onchange="applyFilter()" placeholder="End">
        </div>
      </div>
    </div>

  </div>

  <!-- Right Column: Data Display -->
  <div class="display-column">
    <div id="branchTables">
      <!-- Tables will be injected here -->
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// State Management
let data = JSON.parse(localStorage.getItem('ccData')) || [];
let editIndex = -1;
let sortState = {}; 

// --- DOM Elements ---
const branchTablesDiv = document.getElementById('branchTables');
const form = document.getElementById('dataForm');
const editModeBanner = document.getElementById('editMode');
const addBtn = document.getElementById('addBtn');
const updateBtn = document.getElementById('updateBtn');
const cancelBtn = document.getElementById('cancelBtn');
const formTitle = document.querySelector('.form-container .panel-header h3');

// --- Core Logic ---

function saveData() {
  localStorage.setItem('ccData', JSON.stringify(data));
  updateDashboard();
  renderBranchTables();
}

function addRow() {
  if (!validateForm()) return;
  const entry = getFormData();
  data.push(entry);
  saveData();
  clearInputs();
  showToast('Entry added successfully', 'success');
}

function updateRow() {
  if (editIndex === -1 || !validateForm()) return;
  data[editIndex] = getFormData();
  saveData();
  cancelEdit();
  showToast('Entry updated successfully', 'success');
}

function deleteRow(index) {
  if (confirm("Are you sure you want to delete this entry? This cannot be undone.")) {
    data.splice(index, 1);
    saveData();
    showToast('Entry deleted', 'error');
  }
}

function editRow(index) {
  editIndex = index;
  const entry = data[index];
  
  // Populate Form
  document.getElementById('entryDate').value = entry.date;
  document.getElementById('branchSelect').value = entry.branch;
  document.getElementById('ordersReceived').value = entry.ordersReceived;
  document.getElementById('pickedUp').value = entry.pickedUp;
  document.getElementById('cancelledCC').value = entry.cancelledCC;
  document.getElementById('ordersDelivered').value = entry.delivered;

  // UI Updates
  editModeBanner.style.display = 'flex';
  formTitle.innerHTML = '<i class="fas fa-pen"></i> Edit Entry';
  addBtn.style.display = 'none';
  updateBtn.style.display = 'inline-block';
  cancelBtn.style.display = 'inline-block';
  
  // Highlight the row being edited
  document.querySelectorAll('tbody tr').forEach(tr => tr.style.backgroundColor = '');
  const rows = document.querySelectorAll('tbody tr');
  if(rows[index]) rows[index].style.backgroundColor = '#fff7ed'; // Light orange highlight

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelEdit() {
  editIndex = -1;
  clearInputs();
  editModeBanner.style.display = 'none';
  formTitle.innerHTML = '<i class="fas fa-edit"></i> Data Entry';
  addBtn.style.display = 'inline-block';
  updateBtn.style.display = 'none';
  cancelBtn.style.display = 'none';
  document.querySelectorAll('tbody tr').forEach(tr => tr.style.backgroundColor = '');
}

function getFormData() {
  const ordersReceived = parseInt(document.getElementById('ordersReceived').value) || 0;
  const pickedUp = parseInt(document.getElementById('pickedUp').value) || 0;
  const cancelledCC = parseInt(document.getElementById('cancelledCC').value) || 0;
  const delivered = parseInt(document.getElementById('ordersDelivered').value) || 0;

  // Logic: Difference = (Delivered) - (OrdersReceived - PickedUp - Cancelled)
  // Basically: Did we deliver more than we were supposed to have left for delivery?
  const expectedForDelivery = ordersReceived - pickedUp - cancelledCC;
  const difference = delivered - expectedForDelivery;

  return {
    date: document.getElementById('entryDate').value,
    branch: document.getElementById('branchSelect').value,
    ordersReceived: ordersReceived,
    pickedUp: pickedUp,
    cancelledCC: cancelledCC,
    delivered: delivered,
    difference: difference
  };
}

function validateForm() {
    if (!document.getElementById('entryDate').value) {
        showToast('Please select a date', 'error');
        return false;
    }
    return true;
}

function clearInputs() {
  form.reset();
  // Reset date to today if adding new, or clear if cancelling
  if(editIndex === -1) document.getElementById('entryDate').valueAsDate = new Date();
}

// --- Rendering ---

function updateDashboard() {
  let totalCC = 0, totalPicked = 0, totalDelivered = 0, totalDiff = 0;
  data.forEach(entry => {
    totalCC += entry.ordersReceived;
    totalPicked += entry.pickedUp;
    totalDelivered += entry.delivered;
    totalDiff += entry.difference;
  });

  document.getElementById('totalOrdersCC').innerText = totalCC.toLocaleString();
  document.getElementById('totalPickedUp').innerText = totalPicked.toLocaleString();
  document.getElementById('totalDelivered').innerText = totalDelivered.toLocaleString();
  
  const diffElem = document.getElementById('totalDifference');
  diffElem.innerText = (totalDiff > 0 ? '+' : '') + totalDiff.toLocaleString();
  diffElem.style.color = totalDiff === 0 ? 'var(--dark)' : (totalDiff > 0 ? 'var(--danger)' : 'var(--success)'); // Red for overage usually needs investigation, Green for balanced

  const deliveryRate = totalCC > 0 ? ((totalDelivered / totalCC) * 100) : 0;
  const rateElem = document.getElementById('deliveryRate');
  rateElem.innerText = deliveryRate.toFixed(1) + '%';
  // Color coding rate
  rateElem.className = deliveryRate >= 90 ? 'value green' : (deliveryRate >= 75 ? 'value' : 'value red');
}

function renderBranchTables() {
  branchTablesDiv.innerHTML = '';
  const branches = [...new Set(data.map(d => d.branch))].sort();

  if (data.length === 0) {
    branchTablesDiv.innerHTML = '<div style="text-align:center; padding:40px; color:var(--gray);"><i class="fas fa-inbox" style="font-size:3em; margin-bottom:10px;"></i><br>No Data Available</div>';
    return;
  }

  branches.forEach(branch => {
    const branchData = data.filter(d => d.branch === branch);
    const section = document.createElement('div');
    section.className = 'branch-section';

    // Calculate Stats
    let branchTotalCC = 0, branchTotalDelivered = 0, branchTotalDiff = 0;
    branchData.forEach(entry => {
      branchTotalCC += entry.ordersReceived;
      branchTotalDelivered += entry.delivered;
      branchTotalDiff += entry.difference;
    });
    const branchDeliveryRate = branchTotalCC > 0 ? ((branchTotalDelivered / branchTotalCC) * 100) : 0;
    
    // Status Logic
    let statusClass = 'badge-neutral';
    let statusText = 'Average';
    if (branchDeliveryRate >= 90) { statusClass = 'badge-success'; statusText = 'Excellent'; }
    else if (branchDeliveryRate >= 80) { statusClass = 'badge-warning'; statusText = 'Good'; }
    else { statusClass = 'badge-danger'; statusText = 'Critical'; }

    section.innerHTML = `
      <div class="branch-header">
        <h2><i class="fas fa-building"></i> ${branch} <span class="branch-badge">${statusText}</span></h2>
        <span class="badge ${statusClass}">${branchDeliveryRate.toFixed(1)}% Success</span>
      </div>
      
      <div class="branch-summary">
        <div class="summary-item">
          <div class="label">Orders (In)</div>
          <div class="value">${branchTotalCC.toLocaleString()}</div>
        </div>
        <div class="summary-item">
          <div class="label">Picked Up</div>
          <div class="value">${branchData.reduce((a,b)=>a+b.pickedUp,0).toLocaleString()}</div>
        </div>
        <div class="summary-item">
          <div class="label">Delivered</div>
          <div class="value">${branchTotalDelivered.toLocaleString()}</div>
        </div>
        <div class="summary-item" style="width: 100%; text-align: left;">
          <div style="display:flex; justify-content:space-between;">
            <div class="label">Performance</div>
            <div class="value" style="font-size:1rem;">${branchDeliveryRate.toFixed(1)}%</div>
          </div>
          <div class="chart-bar-bg">
            <div class="chart-bar-fill" style="width: ${Math.min(branchDeliveryRate, 100)}%; background-color: var(--${branchDeliveryRate >= 90 ? 'success' : (branchDeliveryRate >= 80 ? 'warning' : 'danger')})"></div>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="table-${branch.replace(/\s+/g, '-')}">
          <thead>
            <tr>
              <th onclick="sortTable('${branch}', 'date')">Date <i class="fas fa-sort"></i></th>
              <th onclick="sortTable('${branch}', 'ordersReceived')">Orders <i class="fas fa-sort"></i></th>
              <th onclick="sortTable('${branch}', 'pickedUp')">Picked Up <i class="fas fa-sort"></i></th>
              <th onclick="sortTable('${branch}', 'delivered')">Delivered <i class="fas fa-sort"></i></th>
              <th onclick="sortTable('${branch}', 'difference')">Diff <i class="fas fa-sort"></i></th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${generateBranchRows(branchData)}
          </tbody>
        </table>
      </div>`;
    branchTablesDiv.appendChild(section);
  });
  applyFilter();
}

function generateBranchRows(branchData) {
  return branchData.map((entry) => {
    const originalIndex = data.indexOf(entry);
    let diffColor = 'var(--dark)';
    let diffIcon = '';
    
    if (entry.difference === 0) { diffColor = 'var(--success)'; diffIcon = '<i class="fas fa-check"></i>'; }
    else if (Math.abs(entry.difference) <= 2) { diffColor = 'var(--warning)'; diffIcon = '<i class="fas fa-exclamation"></i>'; }
    else { diffColor = 'var(--danger)'; diffIcon = '<i class="fas fa-times"></i>'; }

    return `<tr>
      <td>${entry.date}</td>
      <td>${entry.ordersReceived.toLocaleString()}</td>
      <td>${entry.pickedUp.toLocaleString()}</td>
      <td>${entry.delivered.toLocaleString()}</td>
      <td style="color: ${diffColor}; font-weight:bold;">${diffIcon} ${entry.difference > 0 ? '+' : ''}${entry.difference}</td>
      <td class="no-print">
        <button class="btn btn-sm btn-secondary" onclick="editRow(${originalIndex})"><i class="fas fa-edit"></i></button>
        <button class="btn btn-sm btn-danger" onclick="deleteRow(${originalIndex})"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`;
  }).join('');
}

// --- Utilities ---

function sortTable(branch, column) {
  const tableId = `table-${branch.replace(/\s+/g, '-')}`;
  const table = document.getElementById(tableId);
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));

  // Toggle Direction
  if (!sortState[branch]) sortState[branch] = {};
  sortState[branch][column] = sortState[branch][column] === 'asc' ? 'desc' : 'asc';
  const direction = sortState[branch][column];

  // Extract current data indices from rows to sort the underlying data mapping
  // Simpler approach for this specific HTML structure: Sort the DOM elements based on text content
  
  rows.sort((a, b) => {
    let aVal, bVal;
    // Column indices: 0:Date, 1:Orders, 2:Picked, 3:Delivered, 4:Diff
    switch (column) {
      case 'date': aVal = a.cells[0].innerText; bVal = b.cells[0].innerText; break;
      case 'ordersReceived': aVal = parseInt(a.cells[1].innerText); bVal = parseInt(b.cells[1].innerText); break;
      case 'pickedUp': aVal = parseInt(a.cells[2].innerText); bVal = parseInt(b.cells[2].innerText); break;
      case 'delivered': aVal = parseInt(a.cells[3].innerText); bVal = parseInt(b.cells[3].innerText); break;
      case 'difference': 
        // Clean "+", icons, and commas for diff
        aVal = parseInt(a.cells[4].innerText.replace(/[^0-9-]/g, '')); 
        bVal = parseInt(b.cells[4].innerText.replace(/[^0-9-]/g, '')); 
        break;
    }
    
    if (direction === 'asc') {
      return aVal > bVal ? 1 : (aVal < bVal ? -1 : 0);
    } else {
      return aVal < bVal ? 1 : (aVal > bVal ? -1 : 0);
    }
  });

  rows.forEach(row => tbody.appendChild(row));
}

function applyFilter() {
  const branchFilter = document.getElementById('filterBranch').value;
  const startDateFilter = document.getElementById('filterStartDate').value;
  const endDateFilter = document.getElementById('filterEndDate').value;

  document.querySelectorAll('.branch-section').forEach(section => {
    const branchName = section.querySelector('h2').innerText.replace(/[\n\r]/g, '').replace(/.*\(Update\).*/, '').trim(); // Basic clean
    // The header contains the branch name directly before the badge span or before icon
    // Let's grab it safely from the DOM structure we built:
    const rawText = section.querySelector('.branch-header h2').innerText;
    const sectionBranchName = rawText.split('\n')[0].trim();

    const matchBranch = !branchFilter || sectionBranchName === branchFilter;
    let showSection = false;

    section.querySelectorAll('tbody tr').forEach(row => {
      const date = row.cells[0].innerText;
      const matchDate = (!startDateFilter || date >= startDateFilter) && (!endDateFilter || date <= endDateFilter);
      row.style.display = (matchBranch && matchDate) ? '' : 'none';
      if (row.style.display !== 'none') showSection = true;
    });
    
    section.style.display = showSection ? 'block' : 'none';
  });
}

function clearFilters() {
  document.getElementById('filterBranch').value = '';
  document.getElementById('filterStartDate').value = '';
  document.getElementById('filterEndDate').value = '';
  applyFilter();
}

function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
  
  toast.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
  container.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function exportData() {
  if (data.length === 0) {
    showToast("No data to export", "error");
    return;
  }
  
  let csvContent = "data:text/csv;charset=utf-8,";
  csvContent += "Date,Branch,Orders Received,Picked Up,Cancelled,Delivered,Difference\n";

  data.forEach(row => {
    const rowStr = `${row.date},${row.branch},${row.ordersReceived},${row.pickedUp},${row.cancelledCC},${row.delivered},${row.difference}`;
    csvContent += rowStr + "\n";
  });

  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `operations_report_${new Date().toISOString().slice(0,10)}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('entryDate').valueAsDate = new Date();
  updateDashboard();
  renderBranchTables();
});

</script>
</body>
</html>
