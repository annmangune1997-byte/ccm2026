<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Analytics Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  /* Light Theme */
  --primary: #4361ee;
  --primary-light: #4895ef;
  --secondary: #4cc9f0;
  --success: #2ec4b6;
  --warning: #ff9f1c;
  --danger: #e71d36;
  --bg: #f3f4f6;
  --surface: #ffffff;
  --text-main: #1f2937;
  --text-sec: #6b7280;
  --border: #e5e7eb;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --chart-grid: #f3f4f6;
}

body.dark-mode {
  /* Dark Theme */
  --bg: #111827;
  --surface: #1f2937;
  --text-main: #f9fafb;
  --text-sec: #9ca3af;
  --border: #374151;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
  --chart-grid: #374151;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  margin: 0;
  padding: 20px;
  background-color: var(--bg);
  color: var(--text-main);
  transition: background-color 0.3s, color 0.3s;
}

* { box-sizing: border-box; }

/* --- Header --- */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  background: var(--surface);
  padding: 15px 25px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

header h1 { margin: 0; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
header h1 i { color: var(--primary); }

.header-controls { display: flex; gap: 10px; }

/* --- Buttons --- */
.btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 10px 16px; border: none; border-radius: 8px;
  cursor: pointer; font-size: 0.9rem; font-weight: 600;
  transition: all 0.2s; color: white;
}
.btn-primary { background: var(--primary); }
.btn-primary:hover { background: var(--primary-light); transform: translateY(-1px); }
.btn-secondary { background: var(--text-sec); }
.btn-ghost { background: transparent; color: var(--text-main); border: 1px solid var(--border); }
.btn-ghost:hover { background: rgba(0,0,0,0.05); }
body.dark-mode .btn-ghost:hover { background: rgba(255,255,255,0.05); }
.btn-danger { background: var(--danger); }
.btn-success { background: var(--success); }

/* --- KPI Grid --- */
.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.kpi-card {
  background: var(--surface);
  padding: 20px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  transition: transform 0.2s;
}
.kpi-card:hover { transform: translateY(-4px); }

.kpi-header { display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--text-sec); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
.kpi-value { font-size: 2rem; font-weight: 700; color: var(--text-main); }
.kpi-trend { font-size: 0.8rem; margin-top: 5px; display: inline-block; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.05); }
body.dark-mode .kpi-trend { background: rgba(255,255,255,0.1); }

/* --- Chart Section --- */
.chart-section {
  background: var(--surface);
  padding: 25px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  margin-bottom: 25px;
  border: 1px solid var(--border);
}
.chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
.chart-controls { display: flex; gap: 10px; }
.chart-container {
  width: 100%;
  height: 250px;
  position: relative;
}

/* Custom SVG Chart */
svg.trend-chart { width: 100%; height: 100%; overflow: visible; }
.axis-line { stroke: var(--border); stroke-width: 1; }
.grid-line { stroke: var(--chart-grid); stroke-width: 1; stroke-dasharray: 4; }
.chart-line {
  fill: none;
  stroke: var(--primary);
  stroke-width: 3;
  stroke-linecap: round;
  stroke-linejoin: round;
  filter: drop-shadow(0px 4px 6px rgba(67, 97, 238, 0.4));
  animation: drawLine 1.5s ease-out forwards;
  stroke-dasharray: 2000;
  stroke-dashoffset: 2000;
}
.chart-dot { fill: var(--surface); stroke: var(--primary); stroke-width: 2; r: 4; transition: r 0.2s; cursor: pointer; }
.chart-dot:hover { r: 7; stroke: var(--text-main); }
.tooltip {
  position: absolute;
  background: var(--text-main);
  color: var(--bg);
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  transform: translate(-50%, -150%);
  white-space: nowrap;
  z-index: 10;
}

@keyframes drawLine { to { stroke-dashoffset: 0; } }

/* --- Layout Grid --- */
.main-grid {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 25px;
}
@media (max-width: 1024px) { .main-grid { grid-template-columns: 1fr; } }

/* --- Panels --- */
.panel {
  background: var(--surface);
  padding: 25px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  height: fit-content;
}
.panel-title { margin-top: 0; margin-bottom: 20px; font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

/* Form Elements */
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-sec); font-weight: 500; }
input, select {
  width: 100%;
  padding: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-main);
  font-size: 0.95rem;
  transition: border 0.2s;
}
input:focus, select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
}

/* --- Tables --- */
.table-wrapper { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; min-width: 600px; }
th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border); }
th {
  background: var(--bg);
  color: var(--text-sec);
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  cursor: pointer;
  user-select: none;
}
th:hover { color: var(--text-main); }
tr:last-child td { border-bottom: none; }
tr:hover td { background-color: rgba(0,0,0,0.02); }
body.dark-mode tr:hover td { background-color: rgba(255,255,255,0.02); }

/* --- Badges --- */
.badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
.badge.green { background: rgba(46, 196, 182, 0.15); color: var(--success); }
.badge.red { background: rgba(231, 29, 54, 0.15); color: var(--danger); }
.badge.blue { background: rgba(67, 97, 238, 0.15); color: var(--primary); }

/* --- Branch Sections --- */
.branch-section {
  margin-bottom: 30px;
  border-radius: 16px;
  overflow: hidden;
  animation: slideUp 0.4s ease-out;
}
.branch-header {
  padding: 15px 20px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: 16px 16px 0 0;
  display: flex; justify-content: space-between; align-items: center;
}

/* --- Toast Notification --- */
.toast {
  position: fixed; top: 20px; right: 20px;
  background: var(--surface); color: var(--text-main);
  padding: 15px 20px; border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  display: flex; align-items: center; gap: 12px;
  transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
  z-index: 9999; border-left: 5px solid var(--primary);
}
.toast.show { transform: translateX(0); }
.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--danger); }

/* Animations */
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* Print Overrides */
@media print {
  .no-print, .main-grid > div:first-child, .chart-section, header button { display: none !important; }
  .main-grid { display: block; }
  body { background: white; color: black; }
  .kpi-card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
  .branch-section { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <h1><i class="fas fa-chart-pie"></i> Analytics Pro</h1>
  <div class="header-controls">
    <button class="btn btn-ghost" onclick="toggleTheme()" title="Toggle Dark Mode"><i class="fas fa-moon"></i></button>
    <label for="importFile" class="btn btn-secondary" style="cursor: pointer;"><i class="fas fa-file-import"></i> Import</label>
    <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importData(this)">
    <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-file-export"></i> Export</button>
  </div>
</header>

<!-- KPI Cards -->
<div class="dashboard">
  <div class="kpi-card">
    <div class="kpi-header">Total Orders <i class="fas fa-phone"></i></div>
    <div class="kpi-value" id="totalOrdersCC">0</div>
    <div class="kpi-trend blue">CC Volume</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-header">Delivered <i class="fas fa-truck-fast"></i></div>
    <div class="kpi-value" id="totalDelivered">0</div>
    <div class="kpi-trend green" id="deliveryRate">0%</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-header">Efficiency <i class="fas fa-bolt"></i></div>
    <div class="kpi-value" id="efficiencyScore">0</div>
    <div class="kpi-trend">Pickup vs Deliver</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-header">Variance <i class="fas fa-balance-scale"></i></div>
    <div class="kpi-value" id="totalDifference">0</div>
    <div class="kpi-trend" id="varianceBadge">Balanced</div>
  </div>
</div>

<!-- Custom Chart Section -->
<div class="chart-section">
  <div class="chart-header">
    <h3 style="margin:0;">Delivery Performance Trend</h3>
    <div class="chart-controls">
      <select id="chartBranch" onchange="renderChart()" style="padding: 5px 10px; border-radius: 6px; border: 1px solid var(--border);">
        <option value="All" selected>All Branches</option>
        <option>Hamdan St</option><option>Al Khalidiyah</option><option>Shabiya 11</option>
        <option>Muroor</option><option>Al Majaz</option><option>Al Barsha</option>
        <option>Al Satwa</option><option>Al Rigga</option>
      </select>
      <select id="chartRange" onchange="renderChart()" style="padding: 5px 10px; border-radius: 6px; border: 1px solid var(--border);">
        <option value="7">Last 7 Entries</option>
        <option value="30">Last 30 Entries</option>
        <option value="all">All Time</option>
      </select>
    </div>
  </div>
  <div class="chart-container" id="chartContainer">
    <!-- SVG Chart Rendered Here -->
  </div>
</div>

<div class="main-grid">
  <!-- Sidebar Controls -->
  <div class="controls-column">
    <!-- Input Form -->
    <div class="panel">
      <div class="panel-title">
        <span><i class="fas fa-edit"></i> Data Entry</span>
        <span id="modeIndicator" class="badge blue" style="display:none;">EDIT</span>
      </div>
      
      <div id="editMessage" style="display:none; background:var(--primary); color:white; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.85rem;">
        <i class="fas fa-info-circle"></i> Editing active row. Save or Cancel.
      </div>

      <form id="dataForm" onsubmit="event.preventDefault(); saveEntry();">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="entryDate" required>
        </div>
        <div class="form-group">
          <label>Branch</label>
          <select id="branchSelect">
            <option value="Hamdan St" selected>Hamdan St</option>
            <option>Al Khalidiyah</option><option>Shabiya 11</option>
            <option>Muroor</option><option>Al Majaz</option><option>Al Barsha</option>
            <option>Al Satwa</option><option>Al Rigga</option>
          </select>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <div class="form-group"><label>Orders (In)</label><input type="number" id="ordersReceived" min="0"></div>
          <div class="form-group"><label>Picked Up</label><input type="number" id="pickedUp" min="0"></div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <div class="form-group"><label>Cancelled</label><input type="number" id="cancelledCC" min="0"></div>
          <div class="form-group"><label>Delivered</label><input type="number" id="ordersDelivered" min="0"></div>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button type="submit" class="btn btn-primary" id="submitBtn" style="flex:1"><i class="fas fa-plus"></i> Add</button>
          <button type="button" class="btn btn-ghost" id="cancelBtn" onclick="cancelEdit()" style="display:none;"><i class="fas fa-times"></i></button>
        </div>
      </form>
    </div>

    <!-- Filters -->
    <div class="panel">
      <div class="panel-title"><i class="fas fa-filter"></i> Filters</div>
      <div class="form-group">
        <label>Search Branch</label>
        <select id="filterBranch" onchange="applyFilters()">
          <option value="">All Branches</option>
          <option>Hamdan St</option><option>Al Khalidiyah</option><option>Shabiya 11</option><option>Muroor</option>
          <option>Al Majaz</option><option>Al Barsha</option><option>Al Satwa</option><option>Al Rigga</option>
        </select>
      </div>
      <div class="form-group">
        <label>Date Range</label>
        <input type="date" id="filterStart" onchange="applyFilters()">
        <input type="date" id="filterEnd" onchange="applyFilters()" style="margin-top:5px;">
      </div>
      <button class="btn btn-ghost btn-danger" onclick="clearAllData()" style="width:100%; margin-top:10px; font-size:0.8rem;">
        <i class="fas fa-trash"></i> Reset All Data
      </button>
    </div>
  </div>

  <!-- Tables Area -->
  <div id="tablesArea"></div>
</div>

<!-- Toast Container -->
<div id="toast" class="toast">
  <i class="fas fa-check-circle" id="toastIcon"></i>
  <span id="toastMsg">Action Successful</span>
</div>

<script>
// --- State ---
const DB_KEY = 'pro_dashboard_db';
let data = JSON.parse(localStorage.getItem(DB_KEY)) || [];
let editIndex = -1;

// --- Core Functions ---

function init() {
  document.getElementById('entryDate').valueAsDate = new Date();
  // Load theme preference
  if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
  updateUI();
}

function updateUI() {
  updateKPIs();
  renderTables();
  renderChart();
}

function saveData() {
  localStorage.setItem(DB_KEY, JSON.stringify(data));
  updateUI();
}

function saveEntry() {
  const entry = {
    date: document.getElementById('entryDate').value,
    branch: document.getElementById('branchSelect').value,
    ordersReceived: Number(document.getElementById('ordersReceived').value) || 0,
    pickedUp: Number(document.getElementById('pickedUp').value) || 0,
    cancelledCC: Number(document.getElementById('cancelledCC').value) || 0,
    delivered: Number(document.getElementById('ordersDelivered').value) || 0,
  };
  
  // Calc Difference
  const expected = entry.ordersReceived - entry.pickedUp - entry.cancelledCC;
  entry.difference = entry.delivered - expected;

  if (editIndex > -1) {
    data[editIndex] = entry;
    showToast('Entry Updated', 'success');
    cancelEdit();
  } else {
    data.push(entry);
    showToast('New Entry Added', 'success');
    document.getElementById('dataForm').reset();
    document.getElementById('entryDate').valueAsDate = new Date();
    // Reset branch to Hamdan St for convenience
    document.getElementById('branchSelect').value = "Hamdan St";
  }
  saveData();
}

function editEntry(idx) {
  editIndex = idx;
  const e = data[idx];
  document.getElementById('entryDate').value = e.date;
  document.getElementById('branchSelect').value = e.branch;
  document.getElementById('ordersReceived').value = e.ordersReceived;
  document.getElementById('pickedUp').value = e.pickedUp;
  document.getElementById('cancelledCC').value = e.cancelledCC;
  document.getElementById('ordersDelivered').value = e.delivered;

  // UI Toggle
  document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Update';
  document.getElementById('submitBtn').className = 'btn btn-success';
  document.getElementById('cancelBtn').style.display = 'inline-block';
  document.getElementById('modeIndicator').style.display = 'inline-block';
  document.getElementById('editMessage').style.display = 'block';
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function deleteEntry(idx) {
  if(confirm('Delete this record permanently?')) {
    data.splice(idx, 1);
    saveData();
    showToast('Entry Deleted', 'error');
  }
}

function cancelEdit() {
  editIndex = -1;
  document.getElementById('dataForm').reset();
  document.getElementById('entryDate').valueAsDate = new Date();
  document.getElementById('branchSelect').value = "Hamdan St"; // Default
  document.getElementById('submitBtn').innerHTML = '<i class="fas fa-plus"></i> Add';
  document.getElementById('submitBtn').className = 'btn btn-primary';
  document.getElementById('cancelBtn').style.display = 'none';
  document.getElementById('modeIndicator').style.display = 'none';
  document.getElementById('editMessage').style.display = 'none';
}

function clearAllData() {
  if(confirm('WARNING: This will delete ALL data. Continue?')) {
    data = [];
    saveData();
    showToast('Database Reset', 'error');
  }
}

// --- Rendering ---

function updateKPIs() {
  const totals = data.reduce((acc, cur) => {
    acc.orders += cur.ordersReceived;
    acc.delivered += cur.delivered;
    acc.diff += cur.difference;
    return acc;
  }, { orders: 0, delivered: 0, diff: 0 });

  document.getElementById('totalOrdersCC').innerText = totals.orders.toLocaleString();
  document.getElementById('totalDelivered').innerText = totals.delivered.toLocaleString();
  
  const rate = totals.orders ? ((totals.delivered / totals.orders) * 100).toFixed(1) : 0;
  const rateEl = document.getElementById('deliveryRate');
  rateEl.innerText = rate + '%';
  rateEl.className = 'kpi-trend ' + (rate >= 90 ? 'green' : (rate > 75 ? 'blue' : 'red'));

  const diffEl = document.getElementById('totalDifference');
  diffEl.innerText = (totals.diff > 0 ? '+' : '') + totals.diff.toLocaleString();
  diffEl.style.color = totals.diff === 0 ? 'var(--text-main)' : 'var(--danger)';
  
  document.getElementById('varianceBadge').innerText = totals.diff === 0 ? 'Balanced' : 'Unbalanced';
  
  // Efficiency Score (Picked up / Orders Received)
  const totalPicked = data.reduce((acc,c) => acc + c.pickedUp, 0);
  const eff = totals.orders ? ((totalPicked / totals.orders) * 100).toFixed(0) : 0;
  document.getElementById('efficiencyScore').innerText = eff + '%';
}

function renderTables() {
  const container = document.getElementById('tablesArea');
  const filterBranch = document.getElementById('filterBranch').value;
  const fStart = document.getElementById('filterStart').value;
  const fEnd = document.getElementById('filterEnd').value;

  // Filter Data
  let displayData = data.filter(d => {
    const matchBranch = !filterBranch || d.branch === filterBranch;
    const matchStart = !fStart || d.date >= fStart;
    const matchEnd = !fEnd || d.date <= fEnd;
    return matchBranch && matchStart && matchEnd;
  });

  // Group by Branch
  const groups = {};
  displayData.forEach(d => {
    if(!groups[d.branch]) groups[d.branch] = [];
    groups[d.branch].push(d);
  });

  let html = '';
  for (const [branch, entries] of Object.entries(groups)) {
    // Sort entries by date descending
    entries.sort((a,b) => new Date(b.date) - new Date(a.date));
    
    const branchTotal = entries.reduce((acc, cur) => acc + cur.delivered, 0);
    const rows = entries.map((e, i) => {
      const originalIdx = data.indexOf(e);
      const diffClass = e.difference === 0 ? 'green' : (Math.abs(e.difference) <= 2 ? 'blue' : 'red');
      return `<tr>
        <td>${e.date}</td>
        <td>${e.ordersReceived}</td>
        <td>${e.pickedUp}</td>
        <td>${e.delivered}</td>
        <td><span class="badge ${diffClass}">${e.difference > 0 ? '+' : ''}${e.difference}</span></td>
        <td class="no-print">
          <button class="btn btn-ghost" style="padding:4px 8px;" onclick="editEntry(${originalIdx})"><i class="fas fa-edit"></i></button>
          <button class="btn btn-ghost" style="padding:4px 8px; color:var(--danger)" onclick="deleteEntry(${originalIdx})"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`;
    }).join('');

    html += `
    <div class="branch-section">
      <div class="branch-header">
        <strong style="font-size:1.1rem;"><i class="fas fa-store"></i> ${branch}</strong>
        <span class="badge blue">${entries.length} Entries â€¢ ${branchTotal} Delivered</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Orders</th><th>Picked Up</th><th>Delivered</th><th>Variance</th><th class="no-print">Action</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
  }
  container.innerHTML = html || '<div style="text-align:center; padding:20px; color:var(--text-sec)">No matching data found.</div>';
}

function applyFilters() { renderTables(); }

// --- SVG Charting Engine ---

function renderChart() {
  const container = document.getElementById('chartContainer');
  const range = document.getElementById('chartRange').value;
  const branchFilter = document.getElementById('chartBranch').value;
  
  // Filter by Branch first
  let chartData = [...data].filter(d => branchFilter === 'All' || d.branch === branchFilter);
  
  // Sort by Date
  chartData.sort((a,b) => new Date(a.date) - new Date(b.date));
  
  // Limit Range
  if (range !== 'all') {
    const limit = parseInt(range);
    chartData = chartData.slice(-limit);
  }

  if(chartData.length < 1) {
    container.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-sec);">No data available for this selection</div>';
    return;
  }

  // Dimensions
  const w = container.offsetWidth;
  const h = container.offsetHeight;
  const pad = 40;

  // Scales
  const maxVal = Math.max(...chartData.map(d => d.delivered)) * 1.2 || 10;
  const minVal = 0;
  
  const getX = (i) => pad + (i / (chartData.length - 1 || 1)) * (w - pad * 2);
  const getY = (val) => h - pad - ((val - minVal) / (maxVal - minVal)) * (h - pad * 2);

  // Generate Path
  let pathD = '';
  if (chartData.length > 1) {
      pathD = `M ${getX(0)} ${getY(chartData[0].delivered)}`;
      chartData.forEach((d, i) => {
        pathD += ` L ${getX(i)} ${getY(d.delivered)}`;
      });
  } else {
      // Single point handling
      pathD = `M ${getX(0)} ${getY(chartData[0].delivered)} L ${getX(0)} ${getY(chartData[0].delivered)}`;
  }

  // Generate Dots & Tooltips
  let dotsHTML = '';
  chartData.forEach((d, i) => {
    const x = getX(i);
    const y = getY(d.delivered);
    dotsHTML += `<circle cx="${x}" cy="${y}" class="chart-dot" 
                  onmouseover="showTooltip(evt, '${d.date}', ${d.delivered})" 
                  onmouseout="hideTooltip()"/>`;
  });

  // Grid Lines
  let gridHTML = '';
  for(let i=0; i<=5; i++) {
    const y = h - pad - (i/5)*(h-pad*2);
    gridHTML += `<line x1="${pad}" y1="${y}" x2="${w-pad}" y2="${y}" class="grid-line"/>`;
    gridHTML += `<text x="${pad-10}" y="${y+4}" font-size="10" text-anchor="end" fill="var(--text-sec)">${Math.round(minVal + (i/5)*(maxVal-minVal))}</text>`;
  }

  const svg = `
    <svg class="trend-chart" viewBox="0 0 ${w} ${h}">
      ${gridHTML}
      <path d="${pathD}" class="chart-line" />
      ${dotsHTML}
      <!-- Tooltip Anchor -->
      <div id="tooltip" class="tooltip"></div>
    </svg>
  `;
  container.innerHTML = svg;
}

// Global chart functions for inline events
window.showTooltip = function(evt, date, val) {
  const tt = document.getElementById('tooltip');
  tt.style.left = evt.layerX + 'px';
  tt.style.top = evt.layerY + 'px';
  tt.innerHTML = `<strong>${date}</strong><br>Delivered: ${val}`;
  tt.style.opacity = 1;
}
window.hideTooltip = function() {
  document.getElementById('tooltip').style.opacity = 0;
}

// --- Import / Export ---

function exportData() {
  if(data.length === 0) return showToast('No data to export', 'error');
  const csv = "Date,Branch,Orders,Picked,Cancelled,Delivered,Difference\n" + 
    data.map(r => `${r.date},${r.branch},${r.ordersReceived},${r.pickedUp},${r.cancelledCC},${r.delivered},${r.difference}`).join("\n");
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dashboard_export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  showToast('CSV Exported', 'success');
}

function importData(input) {
  const file = input.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split('\n');
    let count = 0;
    
    // Skip header (index 0)
    for(let i=1; i<lines.length; i++) {
      if(!lines[i].trim()) continue;
      const cols = lines[i].split(',');
      if(cols.length >= 6) {
        const entry = {
          date: cols[0],
          branch: cols[1],
          ordersReceived: Number(cols[2]),
          pickedUp: Number(cols[3]),
          cancelledCC: Number(cols[4]),
          delivered: Number(cols[5]),
          difference: 0 // recalc below
        };
        // Recalc diff
        const exp = entry.ordersReceived - entry.pickedUp - entry.cancelledCC;
        entry.difference = entry.delivered - exp;
        
        data.push(entry);
        count++;
      }
    }
    saveData();
    showToast(`Imported ${count} entries`, 'success');
    input.value = ''; // reset
  };
  reader.readAsText(file);
}

// --- Utilities ---

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  renderChart(); // Redraw chart for axis colors
}

function showToast(msg, type='success') {
  const toast = document.getElementById('toast');
  const icon = document.getElementById('toastIcon');
  const text = document.getElementById('toastMsg');
  
  toast.className = `toast ${type} show`;
  icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
  icon.style.color = type === 'success' ? 'var(--success)' : 'var(--danger)';
  text.innerText = msg;
  
  setTimeout(() => { toast.classList.remove('show'); }, 3000);
}

// Start
window.addEventListener('DOMContentLoaded', init);
window.addEventListener('resize', renderChart); // Responsive chart

</script>
</body>
</html>
